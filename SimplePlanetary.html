<div class="card-body mr-3">
  <!-- Row for sun gear teeth input fields -->
  <div class="form-group row">
    <!-- Label and input for minimum sun gear teeth -->
    <label for="sunmin1" class="col-4 col-form-label">Sun gear minimum teeth</label>
    <input type="number" class="form-control col-2" id="sunmin1" value="8" min="0" max="12" 
           onchange="update1(); this.max = $('#sunmax1')[0].value; $('#sunmax1')[0].min = this.value">
    
    <!-- Label and input for maximum sun gear teeth -->
    <label for="sunmax1" class="col-4 col-form-label">Sun gear maximum teeth</label>
    <input type="number" class="form-control col-2" id="sunmax1" value="12" min="8" 
           onchange="update1(); this.min = $('#sunmin1')[0].value; $('#sunmin1')[0].max = this.value">
  </div>

  <!-- Row for planet gear teeth input fields -->
  <div class="form-group row">
    <!-- Label and input for minimum planet gear teeth -->
    <label for="planetmin1" class="col-4 col-form-label">Planet gear minimum teeth</label>
    <input type="number" class="form-control col-2" id="planetmin1" value="10" min="0" max="16" 
           onchange="update1(); this.max = $('#planetmax1')[0].value; $('#planetmax1')[0].min = this.value">

    <!-- Label and input for maximum planet gear teeth -->
    <label for="planetmax1" class="col-4 col-form-label">Planet gear maximum teeth</label>
    <input type="number" class="form-control col-2" id="planetmax1" value="16" min="10" 
           onchange="update1(); this.min = $('#planetmin1')[0].value; $('#planetmin1')[0].max = this.value">
  </div>

  <!-- Row for ring gear teeth input fields -->
  <div class="form-group row">
    <!-- Label and input for minimum ring gear teeth -->
    <label for="ringmin1" class="col-4 col-form-label">Ring gear minimum teeth</label>
    <input type="number" class="form-control col-2" id="ringmin1" value="26" min="0" max="36" 
           onchange="update1(); this.max = $('#ringmax1')[0].value; $('#ringmax1')[0].min = this.value">

    <!-- Label and input for maximum ring gear teeth -->
    <label for="ringmax1" class="col-4 col-form-label">Ring gear maximum teeth</label>
    <input type="number" class="form-control col-2" id="ringmax1" value="36" min="26" 
           onchange="update1(); this.min = $('#ringmin1')[0].value; $('#ringmin1')[0].max = this.value">
  </div>

  <!-- Row for number of planet gears input fields -->
  <div class="form-group row">
    <!-- Label and input for minimum number of planet gears -->
    <label for="planetnummin1" class="col-4 col-form-label">Minimum number of planets</label>
    <input type="number" class="form-control col-2" id="planetnummin1" value="3" min="2" max="10" 
           onchange="update1(); this.max = $('#planetnummax1')[0].value; $('#planetnummax1')[0].min = this.value">

    <!-- Label and input for maximum number of planet gears -->
    <label for="planetnummax1" class="col-4 col-form-label">Maximum number of planets</label>
    <input type="number" class="form-control col-2" id="planetnummax1" value="10" min="3" 
           onchange="update1(); this.min = $('#planetnummin1')[0].value; $('#planetnummin1')[0].max = this.value">
  </div>

  <!-- Row for input and output selection -->
  <div class="form-group row">
    <!-- Labels and radio buttons for selecting the input gear -->
    <label for="input" class="col-4 mt-auto mb-auto">Input</label>
    <div class="col-2" id="input">
      <div class="custom-control custom-radio">
        <input type="radio" id="inputsun" name="input" class="custom-control-input" checked>
        <label class="custom-control-label" for="inputsun">Sun</label>
      </div>
      <div class="custom-control custom-radio">
        <input type="radio" id="inputcarrier" name="input" class="custom-control-input">
        <label class="custom-control-label" for="inputcarrier">Planet carrier</label>
      </div>
      <div class="custom-control custom-radio">
        <input type="radio" id="inputring" name="input" class="custom-control-input">
        <label class="custom-control-label" for="inputring">Ring</label>
      </div>
    </div>

    <!-- Labels and radio buttons for selecting the output gear -->
    <label for="output" class="col-4 mt-auto mb-auto">Output</label>
    <div class="col-2" id="output">
      <div class="custom-control custom-radio">
        <input type="radio" id="outputsun" name="output" class="custom-control-input">
        <label class="custom-control-label" for="outputsun">Sun</label>
      </div>
      <div class="custom-control custom-radio">
        <input type="radio" id="outputcarrier" name="output" class="custom-control-input" checked>
        <label class="custom-control-label" for="outputcarrier">Planet carrier</label>
      </div>
      <div class="custom-control custom-radio">
        <input type="radio" id="outputring" name="output" class="custom-control-input">
        <label class="custom-control-label" for="outputring">Ring</label>
      </div>
    </div>
  </div>

  <!-- Row for target gear ratio and maximum results -->
  <div class="form-group row mb-3">
    <!-- Label and input for target gear ratio -->
    <label for="target1" class="col-4 col-form-label">Target gear ratio</label>
    <div class="input-group col-2 p-0">
      <input type="number" class="form-control" id="target1" value="4" min="0" aria-describedby="ratio1" onchange="sort1();">
      <div class="input-group-append">
        <span class="input-group-text" id="ratio1">:1</span>
      </div>
    </div>

    <!-- Label and input for maximum number of results to display -->
    <label for="resultsmax1" class="col-4 col-form-label">Maximum number of results</label>
    <input type="number" class="form-control col-2" id="resultsmax1" value="20" min="1">
  </div>

  <!-- Button to start the gear calculation -->
  <button type="button" class="btn btn-primary" onclick="find1()">Find!</button>
  
  <!-- Status indicators for combinations and time remaining -->
  <p class="ml-2 mr-3" id="combinations1" style="display:inline;">Possible combinations: 3080</p>
  <p id="time1" style="display:inline;">Estimated time remaining: N/A</p>

  <!-- Progress bar to show calculation progress -->
  <div class="progress mt-3">
    <div class="progress-bar progress-bar-striped progress-bar-animated" id="bar1" role="progressbar" 
         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
  </div>

  <!-- Container for the list of results -->
  <div class="list-group mt-3" id="results1"></div>

  <!-- Template for individual result items -->
  <template id="resultTemplate1">
    <div class="result1">
      <a class="list-group-item list-group-item-action list-group-item-secondary" id="title" data-toggle="collapse" data-target="#col1" aria-expanded="false" aria-controls="col1" data-ratio="2"></a>
      <div class="list-group-item collapse" id="col1">
        <div id="s">Sun teeth: </div>
        <div id="p">Planet teeth: </div>
        <div id="r">Ring teeth: </div>
        <div id="dist">Planet distance from center: </div>
        <div id="rot">Rotate planets by multiple of: </div>
      </div>
    </div>
  </template>
</div>
		
<script type="text/javascript">
    // Variables to track calculations and progress
    var cps1 = 0; // Combinations per second, used for time estimation
    var checked1 = 0; // Number of checked combinations
    var combinations1 = 3080; // Total number of possible combinations
    var ratioFunction = "(r+s)/s"; // Default ratio formula

    // Function to update the total number of combinations based on user input
    function update1() {
        combinations1 = ($("#sunmax1")[0].value - $("#sunmin1")[0].value) + 1;
        combinations1 *= ($("#planetmax1")[0].value - $("#planetmin1")[0].value) + 1;
        combinations1 *= ($("#ringmax1")[0].value - $("#ringmin1")[0].value) + 1;
        combinations1 *= ($("#planetnummax1")[0].value - $("#planetnummin1")[0].value) + 1;
        $("#combinations1")[0].innerHTML = "Possible combinations: " + combinations1;
    }

    // Function to update progress status and estimated remaining time
    function updateStatus1() {
        var percent = checked1 / combinations1 * 100; // Calculate percentage completed
        var bar = $("#bar1")[0]; // Progress bar element
        bar.attributes["aria-valuenow"] = Math.round(percent); // Update progress bar value
        bar.style = "width: " + percent + "%"; // Update progress bar width
        if (percent != 0 && !isNaN(percent)) {
            bar.innerHTML = Math.round(percent) + "%"; // Display percentage on bar
        } else {
            bar.innerHTML = ""; // Clear bar if no progress
        }

        // Calculate and display estimated time remaining
        var remaining = (combinations1 - checked1) / cps1;
        if (remaining == Infinity || isNaN(remaining)) {
            remaining = "Estimated time remaining: N/A"; // Default if no valid time
        } else {
            remaining = "Estimated time remaining: " + Math.floor(remaining / 3600) + " hours " + Math.floor((remaining % 3600) / 60) + " minutes " + Math.floor((remaining % 60)) + " seconds";
        }
        $("#time1")[0].innerHTML = remaining;
    }

    // Main function to find valid planetary gear configurations
    function find1() {
        $(".result1").remove(); // Clear previous results
        checked1 = 0; // Reset checked combinations
        var time = []; // Array to track time for CPS calculation

        // Disable input fields and button during calculation
        $("#planetary-gear").find("input").toArray().forEach(function(child) {
            child.disabled = true;
        });
        $("#planetary-gear").find("button")[0].disabled = true;

        // Set ratio function based on user-selected input and output types
        if ($("#inputsun")[0].checked) {
            if ($("#outputsun")[0].checked) {
                ratioFunction = "1";
            } else if ($("#outputcarrier")[0].checked) {
                ratioFunction = "(r+s)/s";
            } else {
                ratioFunction = "-(r/s)";
            }
        } else if ($("#inputcarrier")[0].checked) {
            if ($("#outputsun")[0].checked) {
                ratioFunction = "s/(r+s)";
            } else if ($("#outputcarrier")[0].checked) {
                ratioFunction = "1";
            } else {
                ratioFunction = "r/(r+s)";
            }
        } else {
            if ($("#outputsun")[0].checked) {
                ratioFunction = "-(s/r)";
            } else if ($("#outputcarrier")[0].checked) {
                ratioFunction = "(r+s)/r";
            } else {
                ratioFunction = "1";
            }
        }

        // Create a web worker for asynchronous computation
        w = new Worker("planetaryGear.js");
        w.onmessage = function(msg) {
            if (msg.data[0] == 0) { // New valid result
                var s = msg.data[1]; // Sun gear teeth
                var p = msg.data[2]; // Planet gear teeth
                var r = msg.data[3]; // Ring gear teeth
                var pn = msg.data[4]; // Number of planets
                var ratio = eval(ratioFunction); // Calculate gear ratio

                // Clone result template and populate with data
                var entry = $($("#resultTemplate1").clone().prop("content"));
                var id = s + "S" + p + "P" + r + "R" + pn + "PN";
                var attr = document.createAttribute("data-ratio");
                attr.value = ratio;
                entry.find(".result1")[0].setAttributeNode(attr);
                entry.find("#title")[0].attributes["data-target"].value = "#" + id;
                entry.find("#col1")[0].id = id;
                entry.find("#title")[0].attributes["aria-controls"].value = id;
                entry.find("#title")[0].innerHTML = Math.round(ratio * 100) / 100 + ":1 Ratio, " + pn + " Planets";
                entry.find("#s")[0].innerHTML += s;
                entry.find("#p")[0].innerHTML += p;
                entry.find("#r")[0].innerHTML += r;
                entry.find("#dist")[0].innerHTML += (s + p) / 2 + " * module";
                entry.find("#rot")[0].innerHTML += ((360 / pn) / (360 / s)) * (360 / p) + "&#176;";
                $("#results1").append(entry);
                sort1(); // Sort results
            } else if (msg.data[0] == 1) { // Progress update
                checked1 = msg.data[1];
                time.unshift([Date.now(), checked1]);
                if (time.length > 20) {
                    old = time.pop();
                    deltaTime = time[0][0] - old[0];
                    deltaCombinations = time[0][1] - old[1];
                    cps1 = (1000 / deltaTime) * deltaCombinations; // Update CPS
                }
                updateStatus1(); // Update progress bar and time
                update1(); // Refresh combinations count
            } else if (msg.data[0] == 2) { // Calculation complete
                checked1 = combinations1;
                // Re-enable input fields and button
                $("#planetary-gear").find("input").toArray().forEach(function(child) {
                    child.disabled = false;
                });
                $("#planetary-gear").find("button")[0].disabled = false;
                updateStatus1(); // Final update to progress and time
                update1();
                w.terminate(); // Terminate web worker
                w = undefined;
            }
        };

        // Send initial parameters to the worker
        w.postMessage([
            parseInt($("#sunmin1")[0].value), 
            parseInt($("#sunmax1")[0].value), 
            parseInt($("#planetmin1")[0].value), 
            parseInt($("#planetmax1")[0].value), 
            parseInt($("#ringmin1")[0].value), 
            parseInt($("#ringmax1")[0].value), 
            parseInt($("#planetnummin1")[0].value), 
            parseInt($("#planetnummax1")[0].value)
        ]);
    }

    // Function to sort results by closeness to the target ratio
    function sort1() {
        var res = $(".result1").sort(sortFunc1);
        $(".result1").remove(); // Clear previous results
        res.each(function(_, entry) {
            $("#results1").append(entry); // Append sorted results
        });
        // Limit number of displayed results
        if (res.length > $("#resultsmax1")[0].value) {
            $(".result1").toArray().splice($("#resultsmax1")[0].value).forEach(function(r) {
                r.remove();
            });
        }
    }

    // Comparison function for sorting results by ratio difference
    function sortFunc1(a, b) {
        return Math.abs($("#target1")[0].value - Math.abs($(a).data("ratio"))) - Math.abs($("#target1")[0].value - Math.abs($(b).data("ratio")));
    }
</script>
