<div class="card-body mr-3">
  <div class="form-group row">
	<label for="spurgear_min_teeth" class="col-4 col-form-label">Spur gear minimum teeth</label>
	<input type="number" class="form-control col-2" id="spurgear_min_teeth" value="8" min="0" max="12" onchange="spurgear_update(); this.max = $('#spurgear_max_teeth')[0].value; $('#spurgear_max_teeth')[0].min = this.value">
	<label for="spurgear_max_teeth" class="col-4 col-form-label">Spur gear maximum teeth</label>
	<input type="number" class="form-control col-2" id="spurgear_max_teeth" value="12" min="8" onchange="spurgear_update(); this.min = $('#spurgear_min_teeth')[0].value; $('#spurgear_min_teeth')[0].max = this.value">
  </div>
  
  <div class="form-group row">
	<label for="spurgear_max_number" class="col-4 col-form-label">Maximum number of gears</label>
	<input type="number" class="form-control col-2" id="spurgear_max_number" value="2" min="2" onchange="spurgear_update(); this.min = $('#planetnummin1')[0].value; $('#planetnummin1')[0].max = this.value">
  </div>
  
  <div class="form-group row mb-3">
	<label for="spurgear_target_ratio" class="col-4 col-form-label">Target gear ratio</label>
	<div class="input-group col-2 p-0">
	  <input type="number" class="form-control" id="spurgear_target_ratio" value="4" min="0" aria-describedby="spurgear_ratio" onchange="sort1();">
	  <div class="input-group-append">
		<span class="input-group-text" id="spurgear_ratio">:1</span>
	  </div>
	</div>
	
	<label for="spurgear_max_results" class="col-4 col-form-label">Maximum number of results</label>
	<input type="number" class="form-control col-2" id="spurgear_max_results" value="20" min="1">
  </div>
  
  <button type="button" class="btn btn-primary" onclick="spurgear_find()">Find!</button>
  <p class="ml-2 mr-3" id="combinations1" style="display:inline;">Possible combinations: 3080</p>
  <p id="time1" style="display:inline;">Estimated time remaining: N/A</p>
  <div class="progress mt-3">
  
	<div class="progress-bar progress-bar-striped progress-bar-animated" id="spurgear_progressbar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
  </div>
  <div class="list-group mt-3" id="spurgear_results"></div>
  <template id="resultTemplate1">
	<div class="result1">
	  <a class="list-group-item list-group-item-action list-group-item-secondary" id="title" data-toggle="collapse" data-target="#col1" aria-expanded="false" aria-controls="col1" data-ratio="2"></a>
	  <div class="list-group-item collapse" id="col1">
		<div id="s">Spur teeth: </div>
		<div id="p">Planet teeth: </div>
		<div id="r">Ring teeth: </div>
		<div id="dist">Planet distance from center: </div>
		<div id="rot">Rotate planets by multiple of: </div>
	  </div>
	</div>
  </template>
</div>

<script type="text/javascript">
    // Variables to track calculations and progress
    var cps1 = 0; // Combinations per second, used for time estimation
    var checked1 = 0; // Number of checked combinations
    var combinations1 = 3080; // Total number of possible combinations
    var ratioFunction = "(r+s)/s"; // Default ratio formula

    // Function to update the total number of combinations based on user input
    function spurgear_update() {
        combinations1 = ($("#spurgear_max_teeth")[0].value - $("#spurgear_min_teeth")[0].value) + 1;
        combinations1 *= ($("#planetmax1")[0].value - $("#planetmin1")[0].value) + 1;
        combinations1 *= ($("#ringmax1")[0].value - $("#ringmin1")[0].value) + 1;
        combinations1 *= ($("#spurgear_max_number")[0].value - $("#planetnummin1")[0].value) + 1;
        $("#combinations1")[0].innerHTML = "Possible combinations: " + combinations1;
    }

    // Function to update progress status and estimated remaining time
    function updateStatus1() {
        var percent = checked1 / combinations1 * 100; // Calculate percentage completed
        var bar = $("#spurgear_progressbar")[0]; // Progress bar element
        bar.attributes["aria-valuenow"] = Math.round(percent); // Update progress bar value
        bar.style = "width: " + percent + "%"; // Update progress bar width
        if (percent != 0 && !isNaN(percent)) {
            bar.innerHTML = Math.round(percent) + "%"; // Display percentage on bar
        } else {
            bar.innerHTML = ""; // Clear bar if no progress
        }

        // Calculate and display estimated time remaining
        var remaining = (combinations1 - checked1) / cps1;
        if (remaining == Infinity || isNaN(remaining)) {
            remaining = "Estimated time remaining: N/A"; // Default if no valid time
        } else {
            remaining = "Estimated time remaining: " + Math.floor(remaining / 3600) + " hours " + Math.floor((remaining % 3600) / 60) + " minutes " + Math.floor((remaining % 60)) + " seconds";
        }
        $("#time1")[0].innerHTML = remaining;
    }

    // Main function to find valid planetary gear configurations
    function spurgear_find() {
        $(".result1").remove(); // Clear previous results
        checked1 = 0; // Reset checked combinations
        var time = []; // Array to track time for CPS calculation

        // Disable input fields and button during calculation
        $("#planetary-gear").find("input").toArray().forEach(function(child) {
            child.disabled = true;
        });
        $("#planetary-gear").find("button")[0].disabled = true;

        // Set ratio function based on user-selected input and output types
        if ($("#inputsun")[0].checked) {
            if ($("#outputsun")[0].checked) {
                ratioFunction = "1";
            } else if ($("#outputcarrier")[0].checked) {
                ratioFunction = "(r+s)/s";
            } else {
                ratioFunction = "-(r/s)";
            }
        } else if ($("#inputcarrier")[0].checked) {
            if ($("#outputsun")[0].checked) {
                ratioFunction = "s/(r+s)";
            } else if ($("#outputcarrier")[0].checked) {
                ratioFunction = "1";
            } else {
                ratioFunction = "r/(r+s)";
            }
        } else {
            if ($("#outputsun")[0].checked) {
                ratioFunction = "-(s/r)";
            } else if ($("#outputcarrier")[0].checked) {
                ratioFunction = "(r+s)/r";
            } else {
                ratioFunction = "1";
            }
        }

        // Create a web worker for asynchronous computation
        w = new Worker("planetaryGear.js");
        w.onmessage = function(msg) {
            if (msg.data[0] == 0) { // New valid result
                var s = msg.data[1]; // Sun gear teeth
                var p = msg.data[2]; // Planet gear teeth
                var r = msg.data[3]; // Ring gear teeth
                var pn = msg.data[4]; // Number of planets
                var ratio = eval(ratioFunction); // Calculate gear ratio

                // Clone result template and populate with data
                var entry = $($("#resultTemplate1").clone().prop("content"));
                var id = s + "S" + p + "P" + r + "R" + pn + "PN";
                var attr = document.createAttribute("data-ratio");
                attr.value = ratio;
                entry.find(".result1")[0].setAttributeNode(attr);
                entry.find("#title")[0].attributes["data-target"].value = "#" + id;
                entry.find("#col1")[0].id = id;
                entry.find("#title")[0].attributes["aria-controls"].value = id;
                entry.find("#title")[0].innerHTML = Math.round(ratio * 100) / 100 + ":1 Ratio, " + pn + " Planets";
                entry.find("#s")[0].innerHTML += s;
                entry.find("#p")[0].innerHTML += p;
                entry.find("#r")[0].innerHTML += r;
                entry.find("#dist")[0].innerHTML += (s + p) / 2 + " * module";
                entry.find("#rot")[0].innerHTML += ((360 / pn) / (360 / s)) * (360 / p) + "&#176;";
                $("#spurgear_results").append(entry);
                sort1(); // Sort results
            } else if (msg.data[0] == 1) { // Progress update
                checked1 = msg.data[1];
                time.unshift([Date.now(), checked1]);
                if (time.length > 20) {
                    old = time.pop();
                    deltaTime = time[0][0] - old[0];
                    deltaCombinations = time[0][1] - old[1];
                    cps1 = (1000 / deltaTime) * deltaCombinations; // Update CPS
                }
                updateStatus1(); // Update progress bar and time
                spurgear_update(); // Refresh combinations count
            } else if (msg.data[0] == 2) { // Calculation complete
                checked1 = combinations1;
                // Re-enable input fields and button
                $("#planetary-gear").find("input").toArray().forEach(function(child) {
                    child.disabled = false;
                });
                $("#planetary-gear").find("button")[0].disabled = false;
                updateStatus1(); // Final update to progress and time
                spurgear_update();
                w.terminate(); // Terminate web worker
                w = undefined;
            }
        };

        // Send initial parameters to the worker
        w.postMessage([
            parseInt($("#spurgear_min_teeth")[0].value), 
            parseInt($("#spurgear_max_teeth")[0].value), 
            parseInt($("#planetmin1")[0].value), 
            parseInt($("#planetmax1")[0].value), 
            parseInt($("#ringmin1")[0].value), 
            parseInt($("#ringmax1")[0].value), 
            parseInt($("#planetnummin1")[0].value), 
            parseInt($("#spurgear_max_number")[0].value)
        ]);
    }

    // Function to sort results by closeness to the target ratio
    function sort1() {
        var res = $(".result1").sort(sortFunc1);
        $(".result1").remove(); // Clear previous results
        res.each(function(_, entry) {
            $("#spurgear_results").append(entry); // Append sorted results
        });
        // Limit number of displayed results
        if (res.length > $("#spurgear_max_results")[0].value) {
            $(".result1").toArray().splice($("#spurgear_max_results")[0].value).forEach(function(r) {
                r.remove();
            });
        }
    }

    // Comparison function for sorting results by ratio difference
    function sortFunc1(a, b) {
        return Math.abs($("#spurgear_target_ratio")[0].value - Math.abs($(a).data("ratio"))) - Math.abs($("#spurgear_target_ratio")[0].value - Math.abs($(b).data("ratio")));
    }
</script>
